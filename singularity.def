Bootstrap: docker
From: rocker/r-ver:4.3.1

%labels
    Maintainer JCAP
    App GWAS Shiny App
    Purpose GWAS + ML + Enrichment Pipeline
%environment
    export PORT=3838
    export DEBIAN_FRONTEND=noninteractive
    export MAKEFLAGS="-j4"


%post
    set -e
    export DEBIAN_FRONTEND=noninteractive

    apt-get update && apt-get install -y \
        build-essential \
        gfortran \
        libgfortran5 \
        libcurl4-openssl-dev \
        libssl-dev \
        libxml2-dev \
        libgit2-dev \
        libxt-dev \
        libpng-dev \
        libjpeg-dev \
        libbz2-dev \
        liblzma-dev \
        zlib1g-dev \
        libncurses-dev \
        libsqlite3-dev \
        fonts-dejavu \
        pandoc \
        curl \
        wget \
        cmake && \
        apt-get clean && rm -rf /var/lib/apt/lists/*

    mkdir -p /tmp/Rtmp
    export TMPDIR=/tmp/Rtmp

    # Write an R script to install everything (avoids shell quoting hell)
cat >/tmp/install_pkgs.R <<'EOF'
install.packages(
  c("shiny","data.table","DT","ranger","mlr3","mlr3learners",
    "plotly","umap","enrichR","ROCR","pwr"),
  repos = "https://cloud.r-project.org",
  Ncpus = 4
)

if (!requireNamespace("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager", repos = "https://cloud.r-project.org")
}

BiocManager::install(version = "3.18", ask = FALSE)
BiocManager::install(
  c("VariantAnnotation","GenomicFeatures","AnnotationDbi",
    "TxDb.Hsapiens.UCSC.hg19.knownGene","org.Hs.eg.db"),
  ask = FALSE, update = FALSE, dependencies = TRUE
)

if (!"mlr3" %in% rownames(installed.packages())) {
  stop("mlr3 did not install correctly in this image")
}
EOF

    Rscript /tmp/install_pkgs.R
    rm /tmp/install_pkgs.R

%files
    app.R /app/app.R
    www/style.css /app/www/style.css

%runscript
    echo "ðŸ”¥ Starting GWAS Shiny app on port $PORT"
    Rscript -e "options(shiny.port = as.integer(Sys.getenv('PORT')),
                       shiny.host = '0.0.0.0');
                shiny::runApp('/app')"

%test
    R -q -e "library(mlr3); library(VariantAnnotation); cat('All good: mlr3 + Bioc loaded\n')"

